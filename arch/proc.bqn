xml â† â€¢FChars "data-3.5.4.xml"  # https://software.intel.com/sites/landingpage/IntrinsicsGuide/files/data-3.5.4.xml

# An xml parser good enough for our use case
# Accept xml; return (as three lists):
# - Parent index of each tag
# - Contents of open tag
# - Text after last child tag
E â† +`âŠ¸Ã—âŸœÂ¬-âŠ¢
ParseXml â† {
  textâ€¿tags â† <Ë˜â‰âŒŠâ€¿2â¥Š((+âŸœÂ»Eâˆ¨)Ë"<>"=âŒœâŠ¢)âŠ¸âŠ”ğ•©
  dâ†+`ttâ†1-(+ËœâŠ¸+Â´'/'=0â€¿Â¯1âŠ¸âŠ)Â¨tags    # Tag type: Â¯1 close, 0 void, 1 open
  tpâ†(â‹âŠâŸœd)âŠ¸âŠâˆ˜/Ë˜ 1â€¿Â¯1=âŒœtt            # Tag pairs
  ! (âˆ§`' 'âŠ¸â‰ )âŠ¸/Â¨âŠ¸â‰¡âŸœ(1âŠ¸â†“Â¨)ËtpâŠtags    # Tag matching
  oiâ†(0<tt)(âŒˆ`â†•âˆ˜â‰ âŠ¸Ã—)âŠ¸âŠâŒ¾((â‹d)âŠ¸âŠ)â†•â‰ tt  # Open index, for closed and void tags
  ciâ†â‹âŠ¸âŠâ—‹(âˆ¾âŸœ(/0=tt))Ëtp
  piâ†(/0â‰¤tt)(1-Ëœâ‹)Â¯1âŒ¾âŠ‘ciâŠoi          # Parent index
  âŸ¨pi,(0â‰¤tt)/tags,ciâŠtextâŸ©
}
ParseAttr â† {
  nameâ€¿a â† (âŠ‘â‰â—‹<1âŠ¸â†“) (EËœ' 'âŠ¸=>Â·â‰ `'"'âŠ¸=)âŠ¸âŠ”ğ•©
  âŸ¨name, >(EËÂ·âˆ¨`"="""=âŒœâŠ¢)âŠ¸âŠ”Â¨aâŸ©
}

isaList â† "SSE"â€¿"SSE2"â€¿"SSE3"â€¿"SSSE3"â€¿"SSE4.1"â€¿"SSE4.2"â€¿"AVX"â€¿"AVX2"â€¿"FMA"

namesâ€¿GetContâ€¿GetVoid â† {
  parentâ€¿openâ€¿cont â† ParseXml xml
  findOpen â† {(â·ğ•©)âŠ¸âŠâŠ(âŠ”âŠğ•©)Ë™} (âˆ§`' 'âŠ¸â‰ )âŠ¸/Â¨ open
  _on_ â† {ğ”½â—‹((âˆ¾FindOpenğ•˜)âŠ¸âŠ)}
  child â† âŠ” parent
  intr â‡ cont âˆŠâŸœisaListâŠ¸/_on_âŸ¨"CPUID"âŸ© parent
  IG â† intrâŠâŠ”
  GetCont â‡ { parent IG _on_ğ•© cont }
  GetVoid â‡ { parent IGâŸœ((Â¯1âŠ‘Â·ParseAttr Â¯1âŠ¸â†“)Â¨)_on_ğ•© open }
  names â‡ â‰¡Â¨âŸœ(<"name")âŠ¸(âŠ‘âˆ˜/)Ëâˆ˜(â‰1âŠ‘ParseAttr)Â¨ intrâŠopen
}

ProcType â† {
  IsDig â† 1=0â€¿10â‹-âŸœ'0'
  tâ€¿nâ€¿e â† ((1âŠË˜ğ•©)âˆ¾<"")âŠËœ(âŠË˜ğ•©)âŠ"type"â€¿"varname"â€¿"etype"
  pre â† ""
  t â†© " const" {câ†ğ•¨â‰¡(-â‰ ğ•¨)â†‘ğ•©â‹„preâˆ¾â†©câŠ"&*"â‹„(-cÃ—â‰ ğ•¨)â†“ğ•©}âŸœ((-1+' '=Â¯2âŠ¸âŠ‘)âŠ¸â†“)âŸ('*'â‰¡Â¯1âŠ¸âŠ‘) t
  {ğ•¤â‹„preâ€¿tâ†©"IMM"â€¿""}âŸ("IMM"âŠ¸â‰¡) e
  EP â† âˆ¾Â·((â¥ŠÂ¨"uifbm")âŠ‘Ëœ"UI"â€¿"SI"â€¿"FP"â€¿"M"â€¿"MASK"âŠ¸âŠâŒ¾<)âŒ¾âŠ‘IsDigâŠ¸âŠ”
  tpâ€¿act â† <Ë˜â‰âˆ˜â€¿2â¥ŠâŸ¨
    "void"   , âŠ¢
    "float"  , "f32"
    "double" , "f64"
    "__m"    , (("["âˆ¾"]"âˆ¾ËœÂ·â•Ã·â—‹((0<â‰ )â—¶1â€¿â))â—‹(IsDigâŠ¸/)âˆ¾EPâˆ˜âŠ¢)âŸœe
    ""       , âŠ¢
  âŸ©
  act âˆ¾â†© âŸ¨EPâˆ˜eâŸ© # Various integer types
  âŸ¨n, preâˆ¾(tpâŠ¸âŠâŒ¾<(âˆ§`âˆ˜Â¬IsDig)âŠ¸/)â—¶act tâŸ©
}

proto â† (Â¯1â†“âŸ(""â€¿"void"â‰¡âŠ‘)ProcTypeÂ¨)Â¨ GetVoid "return"â€¿"parameter"
cpuidâ€¿cat â† GetContâˆ˜(â¥Š<)Â¨ "CPUID"â€¿"category"
cpuid â†© isaList âŠ âŠ‘Â¨cpuid
instrs â† 0â€¿1âŠ¸âŠ‘Â¨Â¨ GetVoid âŸ¨"instruction"âŸ©
pp â† (âŠ£âˆ¾":"âˆ¾âŠ¢)Â´Â¨Â¨proto
â€¢OutÂ¨ <âˆ˜âˆ¾Ë˜ (cpuidâ‰Ë˜cat) â‹âŠ¸âŠ â‰namesâˆ¾("|"âˆ¾1â†“Â·âˆ¾" "âŠ¸âˆ¾Â¨)Â¨ppâ‰instrs
